# LoadModule perl_module modules/mod_perl.so

ServerAdmin contact@openfoodfacts.org

PerlSwitches -I/srv/off/lib

PerlWarn On

# 20240304 (StÃ©phane) - I couldn't get PerlPassEnv to make the
# environment variable (from the off user or from the root user) available
# to Perl in a non-Docker setup, so using PerlSetEnv for now

PerlSetEnv PRODUCT_OPENER_FLAVOR_SHORT off
PerlSetEnv PRODUCT_OPENER_FLAVOR openfoodfacts

PerlPassEnv PRODUCT_OPENER_DOMAIN
PerlPassEnv PRODUCT_OPENER_PORT
PerlPassEnv PRODUCT_OPENER_FLAVOR
PerlPassEnv PRODUCT_OPENER_FLAVOR_SHORT
PerlPassEnv PRODUCERS_PLATFORM
PerlPassEnv ROBOTOFF_URL
PerlPassEnv QUERY_URL
PerlPassEnv EVENTS_URL
PerlPassEnv FACETS_KP_URL
PerlPassEnv EVENTS_USERNAME
PerlPassEnv EVENTS_PASSWORD
PerlPassEnv REDIS_URL
PerlPassEnv MONGODB_HOST
PerlPassEnv GOOGLE_CLOUD_VISION_API_KEY
PerlPassEnv GOOGLE_CLOUD_VISION_API_URL
PerlPassEnv CROWDIN_PROJECT_IDENTIFIER
PerlPassEnv CROWDIN_PROJECT_KEY
PerlPassEnv GEOLITE2_PATH
PerlPassEnv POSTGRES_USER
PerlPassEnv POSTGRES_PASSWORD
PerlPassEnv LOG_LEVEL_ROOT
PerlPassEnv LOG_LEVEL_MONGODB
PerlPassEnv OFF_LOG_EMAILS
PerlPassEnv BUILD_CACHE_REPO

PerlRequire /srv/off/lib/startup_apache2.pl

# log the X-Forwarded-For IP address (the client ip) in access_log
LogFormat "%{X-Forwarded-For}i %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %T/%D" proxy

<Location /cgi>
SetHandler perl-script
PerlResponseHandler ModPerl::Registry
PerlOptions +ParseHeaders
Options +ExecCGI
Require all granted
</Location>


<VirtualHost *>
DocumentRoot /srv/off/html
ServerName openfoodfacts.org
ErrorLog /srv/off/logs/error_log
CustomLog /srv/off/logs/access_log proxy
LogLevel warn
ScriptAlias /cgi/ "/srv/off/cgi/"

<Directory /srv/off/html>
Require all granted
</Directory>

</VirtualHost>

PerlPostReadRequestHandler get_remote_proxy_address

